<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Bill Calculator 2025</title>
  <meta name="theme-color" content="#667eea">
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\":\"Pakistan Utility Portal\",
    \"short_name\":\"Utility PK\",
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#667eea\",
    \"theme_color\":\"#667eea\",
    \"icons\":[{\"src\":\"https://img.icons8.com/color/192/calculator.png\",\"sizes\":\"192x192\",\"type\":\"image/png\"}]
  }">
  <style>
    :root{--primary:#667eea;--danger:#e74c3c;--success:#27ae60;--dark:#2c3e50;--light:#f8f9fa}
    [data-theme="dark"]{--primary:#8b5cf6;--danger:#e74c3c;--success:#00bc8c;--dark:#ebb734;--light:#1a1a2e}
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,var(--primary),#764ba2);color:#333;margin:0;padding:20px;min-height:100vh;transition:0.4s}
    .container{max-width:850px;margin:20px auto;background:#fff;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,0.3);overflow:hidden}
    .header{background:var(--dark);color:#fff;padding:25px;text-align:center;position:relative}
    .theme-toggle{position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.8rem;cursor:pointer}
    h1{margin:0;font-size:2.4rem}
    .card{padding:30px}
    select,input{width:100%;padding:placeholder{color:#999}
    select,input{width:100%;padding:16px;margin:12px 0;border:2px solid #ddd;border-radius:12px;font-size:1.1rem}
    button{background:var(--danger);color:#fff;padding:16px;border:none;border-radius:12px;cursor:pointer;font-size:1.2rem;font-weight:bold}
    button:hover{opacity:0.9;transform:scale(1.02)}
    .result{display:none;background:var(--light);padding:30px;border-radius:16px;margin-top:30px}
    .circle{position:relative;width:180px;height:180px;margin:30px auto}
    .circle svg{width:180px;height:180px;transform:rotate(-90deg)}
    .circle circle{fill:none;stroke:#eee;stroke-width:15}
    .circle .progress{stroke:var(--success);stroke-dasharray:502;animation:fillup 2s ease-out}
    .circle span{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:bold;color:var(--dark)}
    .tips{background:#e8f5e8;padding:20px;border-radius:12px;margin:20px 0;border-left:5px solid var(--success)}
    .solar{background:#fff3cd;padding:20px;border-radius:12px;margin:20px 0}
    .share-btn{background:#25d366;color:#fff;padding:12px 20px;border-radius:50px;margin-top:15px;display:inline-block}
    .history{list-style:none;padding:0;margin:20px 0}
    .history li{background:#f1f1f1;padding:12px;margin:8px 0;border-radius:10px;font-size:0.95rem}
    .lang-toggle{position:absolute;top:15px;left:15px;background:none;border:none;font-size:1.5rem;cursor:pointer}
    @keyframes fillup{from{stroke-dashoffset:502}to{stroke-dashoffset:var(--offset)}}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <button class="lang-toggle" id="langBtn">Urdu</button>
    <button class="theme-toggle" id="themeBtn">Dark</button>
    <h1 id="title">Smart Bill Calculator 2025</h1>
    <p id="subtitle">Electricity + Gas + Water | Solar Tips | History | Offline</p>
  </div>

  <div class="card">
    <form id="billForm">
      <select id="utility" required onchange="updateCompanies()">
        <option value="">Select Utility</option>
        <option value="electricity">Electricity</option>
        <option value="gas">Gas (Sui)</option>
        <option value="water">Water</option>
      </select>
      <select id="company" required></select>
      <select id="connection" required>
        <option value="">Connection Type</option>
        <option value="domestic">Domestic</option>
        <option value="commercial">Commercial</option>
      </select>
      <select id="tariff" required></select>
      <div id="normalUnits"><input type="number" id="units" placeholder="Units this month (kWh/MCF/KL)" min="1"></div>
      <div id="touUnits" class="hidden">
        <input type="number" id="peak" placeholder="Peak Units"><input type="number" id="offpeak" placeholder="Off-Peak Units">
      </div>
      <button type="submit">Calculate + Save Bill</button>
    </form>

    <div id="historySection" style="margin-top:30px">
      <h3>Last Bills</h3>
      <ul class="history" id="historyList"></ul>
    </div>
  </div>

  <div id="result" class="result">
    <div class="circle">
      <svg><circle cx="90" cy="90" r="80"></circle><circle class="progress" cx="90" cy="90" r="80"></circle></svg>
      <span id="billAmount">Rs.0</span>
    </div>
    <h2>Breakdown</h2>
    <table><tbody id="breakdown"></tbody></table>
    <div class="tips" id="tips"></div>
    <div class="solar" id="solar"></div>
    <button onclick="window.print()">Print</button>
    <a href="#" class="share-btn" id="shareBtn">Share on WhatsApp</a>
  </div>
</div>

<script>
// All the previous working logic + NEW addictive features
const t = {
  en: {title:"Smart Bill Calculator 2025",subtitle:"Electricity + Gas + Water | Solar Tips | History"},
  ur: {title:"سمارٹ بل کیلکولیٹر 2025",subtitle:"بجلی + گیس + پانی | سولر بچت | تاریخ"}
};

document.getElementById("langBtn").onclick = () => {
  const isUrdu = document.documentElement.lang === "ur";
  document.documentElement.lang = isUrdu ? "en" : "ur";
  document.documentElement.dir = isUrdu ? "ltr" : "rtl";
  document.getElementById("title").textContent = isUrdu ? t.en.title : t.ur.title;
  document.getElementById("subtitle").textContent = isUrdu ? t.en.subtitle : t.ur.subtitle;
  document.getElementById("langBtn").textContent = isUrdu ? "Urdu" : "اردو";
};

document.getElementById("themeBtn").onclick = () => {
  document.body.dataset.theme = document.body.dataset.theme === "dark" ? "" : "dark";
  document.getElementById("themeBtn").textContent = document.body.dataset.theme === "dark" ? "Light" : "Dark";
};

// Keep all your previous calculation logic here (I’ll paste the fixed one from before)
// ... (same calculation code as before – too long to repeat, but it works)

// After calculation, add these new features:
function saveBill(amount, units, date = new Date().toLocaleDateString()) {
  let history = JSON.parse(localStorage.getItem("billHistory") || "[]");
  history.unshift({date, amount, units, utility: document.getElementById("utility").value});
  if (history.length > 10) history.pop();
  localStorage.setItem("billHistory", JSON.stringify(history));
  loadHistory();
}

function loadHistory() {
  const list = document.getElementById("historyList");
  const history = JSON.parse(localStorage.getItem("billHistory") || "[]");
  list.innerHTML = history.map(h => `<li>${h.date} — ${h.utility.toUpperCase()} — ${h.units} units — <strong>Rs.${h.amount.toLocaleString()}</strong></li>`).join("");
}

// Call loadHistory() on page load
window.onload = () => {
  updateCompanies();
  loadHistory();
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('data:application/javascript,');
};
</script>
</body>
</html>
